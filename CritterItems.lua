
local addon_name, addon = ...

--
--
--

local Map = {}
addon.Item2Species = Map

--
-- Data (Map[itemid] => speciesid)
--

Map[4401] = 39
Map[8485] = 40
Map[8486] = 41
Map[8487] = 43
Map[8488] = 45
Map[8489] = 46
Map[8490] = 44
Map[8491] = 42
Map[8492] = 50
Map[8494] = 49
Map[8495] = 51
Map[8496] = 47
Map[8497] = 72
Map[8498] = 59
Map[8499] = 58
Map[8500] = 68
Map[8501] = 67
Map[10360] = 75
Map[10361] = 77
Map[10392] = 78
Map[10393] = 55
Map[10394] = 70
Map[10398] = 83
Map[10709] = 70
Map[10822] = 56
Map[11023] = 52
Map[11026] = 65
Map[11027] = 64
Map[11110] = 84
Map[11474] = 87
Map[11825] = 85
Map[11826] = 86
Map[12264] = 89
Map[13582] = 94
Map[13583] = 92
Map[13584] = 93
Map[15996] = 95
Map[16450] = 90
Map[19054] = 758
Map[19055] = 757
Map[19450] = 106
Map[20371] = 107
Map[20651] = 1168
Map[20769] = 114
Map[21277] = 116
Map[21301] = 119
Map[21305] = 120
Map[21308] = 118
Map[21309] = 117
Map[22114] = 121
Map[22235] = 122
Map[22780] = 1073
Map[22781] = 124
Map[23002] = 125
Map[23007] = 126
Map[23015] = 127
Map[23083] = 128
Map[23713] = 130
Map[25535] = 131
Map[27445] = 132
Map[28738] = 125
Map[28740] = 127
Map[29363] = 136
Map[29364] = 137
Map[29901] = 138
Map[29902] = 139
Map[29903] = 140
Map[29904] = 141
Map[29953] = 142
Map[29956] = 143
Map[29957] = 144
Map[29958] = 145
Map[29960] = 146
Map[30360] = 111
Map[31760] = 149
Map[32233] = 153 
Map[32465] = 155
Map[32498] = 155
Map[32588] = 156
Map[32616] = 158
Map[32617] = 157
Map[32622] = 159
Map[33154] = 162
Map[33816] = 163
Map[33818] = 164
Map[33993] = 165
Map[34425] = 191
Map[34478] = 167
Map[34492] = 168 
Map[34493] = 169
Map[34518] = 170
Map[34519] = 171
Map[34535] = 57
Map[35349] = 173
Map[35350] = 174
Map[35504] = 175
Map[37297] = 179
Map[37298] = 180
Map[38050] = 183
Map[38628] = 186
Map[38658] = 187
Map[39286] = 188
Map[39656] = 189
Map[39896] = 194
Map[39898] = 197
Map[39899] = 195
Map[39973] = 190
Map[40653] = 160
Map[41133] = 192
Map[43698] = 193
Map[44721] = 196
Map[44723] = 198
Map[44738] = 199
Map[44794] = 200
Map[44810] = 201
Map[44819] = 202
Map[44822] = 74
Map[44841] = 203
Map[44965] = 204
Map[44970] = 205
Map[44971] = 206
Map[44973] = 207
Map[44974] = 209
Map[44980] = 210
Map[44982] = 213
Map[44983] = 211
Map[44984] = 212
Map[44998] = 214
Map[45002] = 215
Map[45022] = 216
Map[45180] = 217
Map[45606] = 218
Map[45890] = 172
Map[46325] = 220
Map[46398] = 224
Map[46544] = 226
Map[46545] = 225
Map[46707] = 166
Map[46767] = 227
Map[46802] = 228
Map[46820] = 229
Map[46821] = 229
Map[46892] = 217
Map[46894] = 231
Map[48112] = 232
Map[48114] = 233
Map[48116] = 234
Map[48118] = 235
Map[48120] = 236
Map[48122] = 237
Map[48124] = 238
Map[48126] = 239
Map[48527] = 240
Map[49287] = 241
Map[49343] = 242
Map[49362] = 243
Map[49646] = 244
Map[49662] = 245
Map[49663] = 246
Map[49664] = 247
Map[49665] = 248
Map[49693] = 249
Map[49912] = 250
Map[50446] = 251
Map[54436] = 254
Map[54810] = 255
Map[54847] = 256
Map[54857] = 217
Map[56806] = 258
Map[59597] = 261
Map[60216] = 262
Map[60847] = 264
Map[60869] = 265
Map[60955] = 266
Map[62540] = 268
Map[63138] = 270
Map[63355] = 271
Map[63398] = 272
Map[64372] = 277
Map[64403] = 278
Map[64494] = 279
Map[64996] = 271
Map[65361] = 280
Map[65362] = 281
Map[65363] = 282
Map[65364] = 283
Map[65661] = 259
Map[65662] = 260
Map[66067] = 291
Map[66073] = 289
Map[66076] = 286
Map[66080] = 287
Map[67128] = 285
Map[67274] = 267
Map[67275] = 292
Map[67282] = 293
Map[67417] = 188
Map[67418] = 294
Map[68385] = 297
Map[68618] = 296
Map[68619] = 298
Map[68673] = 90
Map[68833] = 301
Map[68840] = 302
Map[68841] = 303
Map[69239] = 306
Map[69251] = 307
Map[69648] = 308
Map[69821] = 309
Map[69824] = 310
Map[69847] = 311
Map[69895] = 344
Map[69896] = 345
Map[69991] = 167
Map[69992] = 229
Map[70099] = 316
Map[70140] = 317
Map[70160] = 318
Map[70908] = 319
Map[71033] = 320
Map[71076] = 321
Map[71140] = 323
Map[71387] = 325
Map[71624] = 328
Map[71726] = 329
Map[72042] = 331
Map[72045] = 332
Map[72068] = 311
Map[72134] = 333
Map[72153] = 665
Map[73762] = 336
Map[73764] = 330
Map[73765] = 335
Map[73797] = 337
Map[73903] = 338
Map[73905] = 339
Map[73953] = 340
Map[74610] = 341
Map[74611] = 342
Map[74932] = 253 
Map[74981] = 343
Map[75906] = 256
Map[76062] = 346
Map[78916] = 347
Map[79744] = 348
Map[80008] = 848
Map[82774] = 845
Map[82775] = 846
Map[84105] = 847
Map[85220] = 650 
Map[85222] = 1042 
Map[85447] = 652
Map[85513] = 802
Map[85578] = 821
Map[85871] = 671
Map[86562] = 835
Map[86563] = 836
Map[86564] = 834
Map[87526] = 844
Map[88147] = 820
Map[88148] = 792
Map[89367] = 850
Map[89368] = 849
Map[89587] = 381
Map[89686] = 856
Map[89736] = 855
Map[90173] = 868
Map[90177] = 903
Map[90897] = 278
Map[90898] = 278
Map[90900] = 1039
Map[90902] = 1040
Map[90953] = 1127
Map[91003] = 1061
Map[91031] = 1062
Map[91040] = 1063
Map[92707] = 1117
Map[92798] = 1124
Map[92799] = 1125
Map[92800] = 1126
Map[93025] = 1142
Map[93029] = 1146
Map[93030] = 1143
Map[93031] = 1145
Map[93032] = 1144
Map[93033] = 1147
Map[93034] = 1149
Map[93035] = 1150
Map[93036] = 1151
Map[93037] = 1153
Map[93038] = 1152
Map[93039] = 1154
Map[93040] = 1155
Map[93041] = 1156  
Map[93669] = 1174
Map[94025] = 1176
Map[94124] = 1178
Map[94125] = 1177
Map[94126] = 1180
Map[94152] = 1183
Map[94190] = 1185
Map[94191] = 1184
Map[94208] = 1196
Map[94209] = 1197
Map[94210] = 1198
Map[94573] = 1205
Map[94574] = 1200
Map[94595] = 1201
Map[94835] = 1202
Map[94903] = 1204
Map[94932] = 1206
Map[94933] = 1207
Map[94934] = 1208
Map[94935] = 1209
Map[95422] = 1211
Map[95423] = 1212
Map[95424] = 1213
Map[95621] = 227
Map[97548] = 1226
Map[97549] = 1227
Map[97550] = 1228
Map[97551] = 1229
Map[97552] = 1230
Map[97553] = 1231
Map[97554] = 1232
Map[97555] = 1233
Map[97556] = 1234
Map[97557] = 1235
Map[97558] = 1236
Map[97959] = 1243
Map[97960] = 1244
Map[97961] = 1245
Map[97821] = 1237
Map[98550] = 1248
-- Map[100870] = Murkimus Tyrannicus

--
-- Helper 
--

local EXCEPTIONS = {
    [629] = true,   -- Shore Crawler (Sold as Spell)
    [630] = true,   -- Gilnean Raven (Sold as Spell)
    [1068] = true,  -- Crow (return value wrong, is caught in wild)
    [1168] = true,  -- Murki (Korean Promotional Event)
}

local ITEM_EXCEPTIONS = {
    [11903] = true, -- Cat Carrier (Corrupted Kitten)
    [19462] = true, -- Unhatched Jubling Egg (pet container)
    [21168] = true, -- Baby Shark (not implemented?)
    [22200] = true, -- Silver Shafted Arrow (fake pet)
    [23712] = true, -- White Tiger Cub (not implemented?)
    [35227] = true, -- Goblin Weather Machine (not a pet)
    [37460] = true, -- Rope Pet Leash (pet accessory)
    [39148] = true, -- Baby Coralshell Turtle (not implemented?)
    [44820] = true, -- Red Ribbon Pet Leash (pet accessory)
    [44972] = true, -- Alarming Clockbot (NOT IN USE)
    [46831] = true, -- Macabre Marionette (fake pet)
    [50301] = true, -- Landro's Pet Box (pet container)
    [62769] = true, -- Hardboiled Egg (not implemented?)
    [66070] = true, -- Lizzy (not implemented?)
    [66075] = true, -- Bubbles (not implemented?)
    [68384] = true, -- Moonkin Egg (pet container)
    [75040] = true, -- Flimsy Darkmoon Balloon (fake pet)
    [75041] = true, -- Flimsy Green Balloon (fake pet)
    [75042] = true, -- Flimsy Yellow Balloon (fake pet)
    [89139] = true, -- Chain Pet Leash (pet accessory)
}

local scanByItem

SLASH_BPCMISSINGSCAN1 = '/bpcmissing'
function SlashCmdList.BPCMISSINGSCAN(msg, editbox)
    local LPJ = LibStub("LibPetJournal-2.0")

    local itemid = tonumber(msg)
    if itemid then
        print("Scanning...")
        return scanByItem(itemid)
    end

    if msg ~= "" then
        -- locate a species by name (include non-obtainable)
        local LPJ = LibStub("LibPetJournal-2.0")

        local maxID = 0
        for _,speciesID  in LPJ:IterateSpeciesIDs() do
            if speciesID > maxID then
                maxID = speciesID
            end
        end

        for speciesID = 1,maxID*1.5 do
            local name, _, _, creatureID = C_PetJournal.GetPetInfoBySpeciesID(speciesID)
            if name and strfind(name, msg) then
                print(format("%s species=%d creature=%d", name, speciesID, creatureID))
            end
        end
        return
    end

    -- list unknown
    local speciesSet = {}
    for itemid, speciesid in pairs(Map) do
        speciesSet[speciesid] = true
    end
    
    local count = 0
    for i,speciesID in LPJ:IterateSpeciesIDs() do
        if not speciesSet[speciesID] then
            local name, _, _, creatureID, sourceText, _, isWild, canBattle = C_PetJournal.GetPetInfoBySpeciesID(speciesID)
            if not isWild and not strfind(sourceText, "Achievement:") and not EXCEPTIONS[speciesID] then
                count = count + 1
                print(format("%s species=%d creature=%d", name, speciesID, creatureID))
            end
        end
    end
    
    print(format("%d pets missing from table.", count))
end

--
-- item scanner
--

do
    local updateFrame

    local itemsInfoSize = 0
    local itemsInfo = {}
    local maxitem

    local remove = {}
    local function runQueue() 
        local hit
        local now = GetTime()

        while itemsInfoSize < 500 and maxitem > 1 do
            maxitem = maxitem - 1
            if not Map[maxitem] and not ITEM_EXCEPTIONS[maxitem] then
                itemsInfo[maxitem] = now
                itemsInfoSize = itemsInfoSize + 1
            end
        end
        
        wipe(remove)
        for itemid, start in pairs(itemsInfo) do
            if now - start > 3 then
                tinsert(remove, itemid)
            else
                local name, _, _, _, _, _, subclass = GetItemInfo(itemid)
                if name then
                    if subclass == "Companion Pets" then
                        print(format("%s (itemid=%d)", name, itemid))
                    end
                    tinsert(remove, itemid)
                end
            end
        end

        for _, itemid in ipairs(remove) do
            itemsInfo[itemid] = nil
            itemsInfoSize = itemsInfoSize - 1
        end
    end

    local totalElapsed = 0
    local function updateFrame_OnUpdate(self, elapsed)
        totalElapsed = totalElapsed + elapsed
        if totalElapsed > 0.4 then
            totalElapsed = 0

            runQueue()
            if itemsInfoSize == 0 and maxitem <= 1 and self.item == nil then
                print("Finished")
                return self:Hide()
            end
        end
    end

    function scanByItem(itemid)
        if not updateFrame then
            updateFrame = CreateFrame("Frame")
            updateFrame:SetScript("OnUpdate", updateFrame_OnUpdate)
        end

        wipe(itemsInfo)
        itemsInfoSize = 0
        maxitem = itemid + 1

        runQueue()
        updateFrame:Show()
    end
end
